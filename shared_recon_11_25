Add-Type -AssemblyName System.Windows.Forms

# Folder selection dialog
$folderBrowser = New-Object System.Windows.Forms.FolderBrowserDialog
$folderBrowser.Description = "Select the root directory to scan"
$dialogResult = $folderBrowser.ShowDialog()

if ($dialogResult -ne [System.Windows.Forms.DialogResult]::OK) { exit }

$rootPath = $folderBrowser.SelectedPath
$outputFile = "C:\path\to\secret_scan_results.txt"

# Clear previous output
"" | Out-File $outputFile

# Keywords and sensitive patterns
$patterns = @(
    "password", "passwd", "credential", "creds?",
    "apikey", "api key", "token", "secret", "auth", "bearer",
    "jwt", "refresh_token", "sessionid", "access_token",

    # Cloud keys
    "AKIA[0-9A-Z]{16}",
    "ASIA[0-9A-Z]{16}",
    "AIza[0-9A-Za-z\-_]{35}",
    "ya29.[0-9A-Za-z\-_]+",
    "sk_live_[0-9A-Za-z]+",
    "sk_test_[0-9A-Za-z]+",

    # Private keys
    "-----BEGIN PRIVATE KEY-----",
    "-----BEGIN RSA PRIVATE KEY-----",
    "-----BEGIN OPENSSH PRIVATE KEY-----",
    "-----BEGIN EC PRIVATE KEY-----",
    "-----BEGIN DSA PRIVATE KEY-----",

    # Certificates
    "-----BEGIN CERTIFICATE-----",
    "-----BEGIN PGP MESSAGE-----",
    "ssh-rsa", "ssh-ed25519",

    # DB credentials
    "connectionstring", "uid=", "pwd=", "db_password", "db_user"
)

# Extract text from various formats
function Get-FileText($path) {
    try {
        switch ($path.Extension.ToLower()) {
            ".txt" { return Get-Content $path -Raw -ErrorAction SilentlyContinue }
            ".json" { return Get-Content $path -Raw -ErrorAction SilentlyContinue }
            ".xml" { return Get-Content $path -Raw -ErrorAction SilentlyContinue }
            ".html" { return Get-Content $path -Raw -ErrorAction SilentlyContinue }
            ".md" { return Get-Content $path -Raw -ErrorAction SilentlyContinue }
            ".yaml" { return Get-Content $path -Raw -ErrorAction SilentlyContinue }
            ".yml" { return Get-Content $path -Raw -ErrorAction SilentlyContinue }
            ".ini" { return Get-Content $path -Raw -ErrorAction SilentlyContinue }
            ".csv" { return Get-Content $path -Raw -ErrorAction SilentlyContinue }

            ".docx" { return (Expand-Zip -Path $path.FullName) }
            ".xlsx" { return (Expand-Zip -Path $path.FullName) }
            ".pptx" { return (Expand-Zip -Path $path.FullName) }

            default { return $null }
        }
    }
    catch { return $null }
}

# Extract XML/TXT from Office ZIP containers
function Expand-Zip($Path) {
    try {
        $tmp = Join-Path $env:TEMP ([System.IO.Path]::GetRandomFileName())
        Expand-Archive -LiteralPath $Path -DestinationPath $tmp -ErrorAction SilentlyContinue
        $text = Get-ChildItem $tmp -Recurse -File -ErrorAction SilentlyContinue |
            Where-Object {$_.Extension -match "xml|txt|json"} |
            ForEach-Object { Get-Content $_.FullName -Raw -ErrorAction SilentlyContinue }

        Remove-Item $tmp -Recurse -Force -ErrorAction SilentlyContinue
        return $text
    }
    catch { return $null }
}

# Safely walk directories even with access denied
Get-ChildItem -Path $rootPath -Recurse -File -Force -ErrorAction SilentlyContinue |
ForEach-Object {
    $file = $_.FullName
    Write-Host "Scanning: $file"

    $content = Get-FileText $_
    if (-not $content) { return }

    foreach ($pattern in $patterns) {
        try {
            if ($content -match $pattern) {
                $msg = "MATCH: '$pattern' in $file"
                $msg | Tee-Object -FilePath $outputFile -Append
                Write-Host $msg -ForegroundColor Yellow
            }
        }
        catch { continue }
    }
}

Write-Host "Scan complete. Results saved to $outputFile"
